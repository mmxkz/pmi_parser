require 'restclient'

class PmiGrabberJob < ApplicationJob
  PMI_URL = "https://certification.pmi.org/registry.aspx".freeze
  VIEWSATE = '/wEPDwUJMTE5MTEyOTU2D2QWAgIDD2QWAgIDDxQrAAMPBYIBQztDOlBNSS5XZWIuRnJhbWV3b3JrLkR5bmFtaWNQbGFjZWhvbGRlciwgUE1JLldlYiwgVmVyc2lvbj0yLjAuNjU1MC4zMTkxMSwgQ3VsdHVyZT1uZXV0cmFsLCBQdWJsaWNLZXlUb2tlbj1udWxsO0NvbnRlbnRQbGFjZWhvbGRlchYBDwVEQztVQzpBU1AucmVnaXN0cnlfcmVnaXN0cnljb250ZW50X2FzY3g6L1JlZ2lzdHJ5O2RwaF9SZWdpc3RyeUNvbnRlbnQWAGRkFgJmD2QWAmYPZBYGAgEPDxYCHgRUZXh0BQFBZGQCBw8QZA8W+AFmAgECAgIDAgQCBQIGAgcCCAIJAgoCCwIMAg0CDgIPAhACEQISAhMCFAIVAhYCFwIYAhkCGgIbAhwCHQIeAh8CIAIhAiICIwIkAiUCJgInAigCKQIqAisCLAItAi4CLwIwAjECMgIzAjQCNQI2AjcCOAI5AjoCOwI8Aj0CPgI/AkACQQJCAkMCRAJFAkYCRwJIAkkCSgJLAkwCTQJOAk8CUAJRAlICUwJUAlUCVgJXAlgCWQJaAlsCXAJdAl4CXwJgAmECYgJjAmQCZQJmAmcCaAJpAmoCawJsAm0CbgJvAnACcQJyAnMCdAJ1AnYCdwJ4AnkCegJ7AnwCfQJ+An8CgAECgQECggECgwEChAEChQEChgEChwECiAECiQECigECiwECjAECjQECjgECjwECkAECkQECkgECkwEClAEClQEClgEClwECmAECmQECmgECmwECnAECnQECngECnwECoAECoQECogECowECpAECpQECpgECpwECqAECqQECqgECqwECrAECrQECrgECrwECsAECsQECsgECswECtAECtQECtgECtwECuAECuQECugECuwECvAECvQECvgECvwECwAECwQECwgECwwECxAECxQECxgECxwECyAECyQECygECywECzAECzQECzgECzwEC0AEC0QEC0gEC0wEC1AEC1QEC1gEC1wEC2AEC2QEC2gEC2wEC3AEC3QEC3gEC3wEC4AEC4QEC4gEC4wEC5AEC5QEC5gEC5wEC6AEC6QEC6gEC6wEC7AEC7QEC7gEC7wEC8AEC8QEC8gEC8wEC9AEC9QEC9gEC9wEW+AEQBRBTZWxlY3QgYSBDb3VudHJ5BQEwZxAFC0FmZ2hhbmlzdGFuBQNBRkdnEAUOw4VsYW5kIElzbGFuZHMFA0FMQWcQBQdBbGJhbmlhBQNBTEJnEAUHQWxnZXJpYQUDRFpBZxAFDkFtZXJpY2FuIFNhbW9hBQNBU01nEAUHQW5kb3JyYQUDQU5EZxAFBkFuZ29sYQUDQUdPZxAFCEFuZ3VpbGxhBQNBSUFnEAUKQW50YXJjdGljYQUDQVRBZxAFE0FudGlndWEgYW5kIEJhcmJ1ZGEFA0FUR2cQBQlBcmdlbnRpbmEFA0FSR2cQBQdBcm1lbmlhBQNBUk1nEAUFQXJ1YmEFA0FCV2cQBQlBdXN0cmFsaWEFA0FVU2cQBQdBdXN0cmlhBQNBVVRnEAUKQXplcmJhaWphbgUDQVpFZxAFB0JhaGFtYXMFA0JIU2cQBQdCYWhyYWluBQNCSFJnEAUKQmFuZ2xhZGVzaAUDQkdEZxAFCEJhcmJhZG9zBQNCUkJnEAUHQmVsYXJ1cwUDQkxSZxAFB0JlbGdpdW0FA0JFTGcQBQZCZWxpemUFA0JMWmcQBQVCZW5pbgUDQkVOZxAFB0Jlcm11ZGEFA0JNVWcQBQZCaHV0YW4FA0JUTmcQBQdCb2xpdmlhBQNCT0xnEAUgQm9uYWlyZSwgU2ludCBFdXN0YXRpdXMgYW5kIFNhYmEFA0JFU2cQBRZCb3NuaWEgYW5kIEhlcnplZ292aW5hBQNCSUhnEAUIQm90c3dhbmEFA0JXQWcQBQ1Cb3V2ZXQgSXNsYW5kBQNCVlRnEAUGQnJhemlsBQNCUkFnEAUeQnJpdGlzaCBJbmRpYW4gT2NlYW4gVGVycml0b3J5BQNJT1RnEAUWQnJpdGlzaCBWaXJnaW4gSXNsYW5kcwUDVkdCZxAFEUJydW5laSBEYXJ1c3NhbGFtBQNCUk5nEAUIQnVsZ2FyaWEFA0JHUmcQBQxCdXJraW5hIEZhc28FA0JGQWcQBQdCdXJ1bmRpBQNCRElnEAUIQ2FtYm9kaWEFA0tITWcQBQhDYW1lcm9vbgUDQ01SZxAFBkNhbmFkYQUDQ0FOZxAFCkNhcGUgVmVyZGUFA0NQVmcQBQ5DYXltYW4gSXNsYW5kcwUDQ1lNZxAFGENlbnRyYWwgQWZyaWNhbiBSZXB1YmxpYwUDQ0FGZxAFBENoYWQFA1RDRGcQBQVDaGlsZQUDQ0hMZxAFD0NoaW5hLCBtYWlubGFuZAUDQ0hOZxAFEENocmlzdG1hcyBJc2xhbmQFA0NYUmcQBRdDb2NvcyAoS2VlbGluZykgSXNsYW5kcwUDQ0NLZxAFCENvbG9tYmlhBQNDT0xnEAUHQ29tb3JvcwUDQ09NZxAFEENvbmdvLCBEZW0uIFJlcC4FA0NPRGcQBQtDb25nbywgUmVwLgUDQ09HZxAFDENvb2sgSXNsYW5kcwUDQ09LZxAFCkNvc3RhIFJpY2EFA0NSSWcQBQ5Dw7R0ZSBkJ0l2b2lyZQUDQ0lWZxAFB0Nyb2F0aWEFA0hSVmcQBQRDdWJhBQNDVUJnEAUIQ3VyYcOnYW8FA0NVV2cQBQZDeXBydXMFA0NZUGcQBQ5DemVjaCBSZXB1YmxpYwUDQ1pFZxAFB0Rlbm1hcmsFA0ROS2cQBQhEamlib3V0aQUDREpJZxAFCERvbWluaWNhBQNETUFnEAUSRG9taW5pY2FuIFJlcHVibGljBQNET01nEAUHRWN1YWRvcgUDRUNVZxAFBUVneXB0BQNFR1lnEAULRWwgU2FsdmFkb3IFA1NMVmcQBRFFcXVhdG9yaWFsIEd1aW5lYQUDR05RZxAFB0VyaXRyZWEFA0VSSWcQBQdFc3RvbmlhBQNFU1RnEAUIRXRoaW9waWEFA0VUSGcQBSFGYWxrbGFuZCBJc2xhbmRzIChJc2xhcyBNYWx2aW5hcykFA0ZMS2cQBQ1GYXJvZSBJc2xhbmRzBQNGUk9nEAUeRmVkZXJhdGVkIFN0YXRlcyBvZiBNaWNyb25lc2lhBQNGU01nEAUERmlqaQUDRkpJZxAFB0ZpbmxhbmQFA0ZJTmcQBQZGcmFuY2UFA0ZSQWcQBQ1GcmVuY2ggR3VpYW5hBQNHVUZnEAUQRnJlbmNoIFBvbHluZXNpYQUDUFlGZxAFG0ZyZW5jaCBTb3V0aGVybiBUZXJyaXRvcmllcwUDQVRGZxAFBUdhYm9uBQNHQUJnEAUGR2FtYmlhBQNHTUJnEAUHR2VvcmdpYQUDR0VPZxAFB0dlcm1hbnkFA0RFVWcQBQVHaGFuYQUDR0hBZxAFCUdpYnJhbHRhcgUDR0lCZxAFBkdyZWVjZQUDR1JDZxAFCUdyZWVubGFuZAUDR1JMZxAFB0dyZW5hZGEFA0dSRGcQBQpHdWFkZWxvdXBlBQNHTFBnEAUER3VhbQUDR1VNZxAFCUd1YXRlbWFsYQUDR1RNZxAFBkd1aW5lYQUDR0lOZxAFDUd1aW5lYS1CaXNzYXUFA0dOQmcQBQZHdXlhbmEFA0dVWWcQBQVIYWl0aQUDSFRJZxAFIUhlYXJkIElzbGFuZCBhbmQgTWNEb25hbGQgSXNsYW5kcwUDSE1EZxAFCEhvbmR1cmFzBQNITkRnEAUJSG9uZyBLb25nBQNIS0dnEAUHSHVuZ2FyeQUDSFVOZxAFB0ljZWxhbmQFA0lTTGcQBQVJbmRpYQUDSU5EZxAFCUluZG9uZXNpYQUDSUROZxAFGUlyYW4sIElzbGFtaWMgUmVwdWJsaWMgb2YFA0lSTmcQBQRJcmFxBQNJUlFnEAUHSXJlbGFuZAUDSVJMZxAFBklzcmFlbAUDSVNSZxAFBUl0YWx5BQNJVEFnEAUHSmFtYWljYQUDSkFNZxAFBUphcGFuBQNKUE5nEAUGSm9yZGFuBQNKT1JnEAUKS2F6YWtoc3RhbgUDS0FaZxAFBUtlbnlhBQNLRU5nEAUIS2lyaWJhdGkFA0tJUmcQBQZLdXdhaXQFA0tXVGcQBQpLeXJneXpzdGFuBQNLR1pnEAUETGFvcwUDTEFPZxAFBkxhdHZpYQUDTFZBZxAFB0xlYmFub24FA0xCTmcQBQdMZXNvdGhvBQNMU09nEAUHTGliZXJpYQUDTEJSZxAFFkxpYnlhbiBBcmFiIEphbWFoaXJpeWEFA0xCWWcQBQ1MaWVjaHRlbnN0ZWluBQNMSUVnEAUJTGl0aHVhbmlhBQNMVFVnEAUKTHV4ZW1ib3VyZwUDTFVYZxAFBU1hY2FvBQNNQUNnEAUqTWFjZWRvbmlhLCBUaGUgRm9ybWVyIFl1Z29zbGF2IFJlcHVibGljIG9mBQNNS0RnEAUKTWFkYWdhc2NhcgUDTURHZxAFBk1hbGF3aQUDTVdJZxAFCE1hbGF5c2lhBQNNWVNnEAUITWFsZGl2ZXMFA01EVmcQBQRNYWxpBQNNTElnEAUFTWFsdGEFA01MVGcQBRBNYXJzaGFsbCBJc2xhbmRzBQNNSExnEAUKTWFydGluaXF1ZQUDTVRRZxAFCk1hdXJpdGFuaWEFA01SVGcQBQlNYXVyaXRpdXMFA01VU2cQBQdNYXlvdHRlBQNNWVRnEAUGTWV4aWNvBQNNRVhnEAUUTW9sZG92YSwgUmVwdWJsaWMgb2YFA01EQWcQBQZNb25hY28FA01DT2cQBQhNb25nb2xpYQUDTU5HZxAFCk1vbnRlbmVncm8FA01ORWcQBQpNb250c2VycmF0BQNNU1JnEAUHTW9yb2NjbwUDTUFSZxAFCk1vemFtYmlxdWUFA01PWmcQBQdNeWFubWFyBQNNTVJnEAUHTmFtaWJpYQUDTkFNZxAFBU5hdXJ1BQNOUlVnEAUFTmVwYWwFA05QTGcQBQtOZXRoZXJsYW5kcwUDTkxEZxAFFE5ldGhlcmxhbmRzIEFudGlsbGVzBQNBTlRnEAUNTmV3IENhbGVkb25pYQUDTkNMZxAFC05ldyBaZWFsYW5kBQNOWkxnEAUJTmljYXJhZ3VhBQNOSUNnEAUFTmlnZXIFA05FUmcQBQdOaWdlcmlhBQNOR0FnEAUETml1ZQUDTklVZxAFDk5vcmZvbGsgSXNsYW5kBQNORktnEAULTm9ydGggS29yZWEFA1BSS2cQBRhOb3J0aGVybiBNYXJpYW5hIElzbGFuZHMFA01OUGcQBQZOb3J3YXkFA05PUmcQBQRPbWFuBQNPTU5nEAUIUGFraXN0YW4FA1BBS2cQBQVQYWxhdQUDUExXZxAFE1BhbGVzdGluZSwgU3RhdGUgb2YFA1BTRWcQBQZQYW5hbWEFA1BBTmcQBRBQYXB1YSBOZXcgR3VpbmVhBQNQTkdnEAUIUGFyYWd1YXkFA1BSWWcQBQRQZXJ1BQNQRVJnEAULUGhpbGlwcGluZXMFA1BITGcQBQhQaXRjYWlybgUDUENOZxAFBlBvbGFuZAUDUE9MZxAFCFBvcnR1Z2FsBQNQUlRnEAULUHVlcnRvIFJpY28FA1BSSWcQBQVRYXRhcgUDUUFUZxAFCFLDqXVuaW9uBQNSRVVnEAUHUm9tYW5pYQUDUk9VZxAFElJ1c3NpYW4gRmVkZXJhdGlvbgUDUlVTZxAFBlJ3YW5kYQUDUldBZxAFEVNhaW50IEJhcnRow6lsZW15BQNCTE1nEAUMU2FpbnQgSGVsZW5hBQNTSE5nEAUVU2FpbnQgS2l0dHMgYW5kIE5ldmlzBQNLTkFnEAULU2FpbnQgTHVjaWEFA0xDQWcQBRpTYWludCBNYXJ0aW4gKEZyZW5jaCBwYXJ0KQUDTUFGZxAFIFNhaW50IFZpbmNlbnQgYW5kIHRoZSBHcmVuYWRpbmVzBQNWQ1RnEAUZU2FpbnQtUGllcnJlIGFuZCBNaXF1ZWxvbgUDU1BNZxAFBVNhbW9hBQNXU01nEAUKU2FuIE1hcmlubwUDU01SZxAFGFPDo28gVG9tw6kgYW5kIFByw61uY2lwZQUDU1RQZxAFDFNhdWRpIEFyYWJpYQUDU0FVZxAFB1NlbmVnYWwFA1NFTmcQBQZTZXJiaWEFA1NSQmcQBQpTZXljaGVsbGVzBQNTWUNnEAUMU2llcnJhIExlb25lBQNTTEVnEAUJU2luZ2Fwb3JlBQNTR1BnEAUZU2ludCBNYWFydGVuIChEdXRjaCBwYXJ0KQUDU1hNZxAFCFNsb3Zha2lhBQNTVktnEAUIU2xvdmVuaWEFA1NWTmcQBQ9Tb2xvbW9uIElzbGFuZHMFA1NMQmcQBQdTb21hbGlhBQNTT01nEAUMU291dGggQWZyaWNhBQNaQUZnEAUsU291dGggR2VvcmdpYSBhbmQgdGhlIFNvdXRoIFNhbmR3aWNoIElzbGFuZHMFA1NHU2cQBQtTb3V0aCBLb3JlYQUDS09SZxAFC1NvdXRoIFN1ZGFuBQNTU0RnEAUFU3BhaW4FA0VTUGcQBQlTcmkgTGFua2EFA0xLQWcQBQVTdWRhbgUDU0ROZxAFCFN1cmluYW1lBQNTVVJnEAUWU3ZhbGJhcmQgYW5kIEphbiBNYXllbgUDU0pNZxAFCVN3YXppbGFuZAUDU1daZxAFBlN3ZWRlbgUDU1dFZxAFC1N3aXR6ZXJsYW5kBQNDSEVnEAUUU3lyaWFuIEFyYWIgUmVwdWJsaWMFA1NZUmcQBRpUYWl3YW4gKFJlcHVibGljIG9mIENoaW5hKQUDVFdOZxAFClRhamlraXN0YW4FA1RKS2cQBRxUYW56YW5pYSwgVW5pdGVkIFJlcHVibGljIE9mBQNUWkFnEAUIVGhhaWxhbmQFA1RIQWcQBQtUaW1vci1MZXN0ZQUDVExTZxAFBFRvZ28FA1RHT2cQBQdUb2tlbGF1BQNUS0xnEAUFVG9uZ2EFA1RPTmcQBRNUcmluaWRhZCBhbmQgVG9iYWdvBQNUVE9nEAUHVHVuaXNpYQUDVFVOZxAFBlR1cmtleQUDVFVSZxAFDFR1cmttZW5pc3RhbgUDVEtNZxAFGFR1cmtzIGFuZCBDYWljb3MgSXNsYW5kcwUDVENBZxAFBlR1dmFsdQUDVFVWZxAFE1UuUy4gVmlyZ2luIElzbGFuZHMFA1ZJUmcQBQZVZ2FuZGEFA1VHQWcQBQdVa3JhaW5lBQNVS1JnEAUUVW5pdGVkIEFyYWIgRW1pcmF0ZXMFA0FSRWcQBQ5Vbml0ZWQgS2luZ2RvbQUDR0JSZxAFDVVuaXRlZCBTdGF0ZXMFA1VTQWcQBSRVbml0ZWQgU3RhdGVzIE1pbm9yIE91dGx5aW5nIElzbGFuZHMFA1VNSWcQBQdVcnVndWF5BQNVUllnEAUKVXpiZWtpc3RhbgUDVVpCZxAFB1ZhbnVhdHUFA1ZVVGcQBQdWYXRpY2FuBQNWQVRnEAUJVmVuZXp1ZWxhBQNWRU5nEAUIVmlldCBOYW0FA1ZOTWcQBRFXYWxsaXMgYW5kIEZ1dHVuYQUDV0xGZxAFDldlc3Rlcm4gU2FoYXJhBQNFU0hnEAUFWWVtZW4FA1lFTWcQBQZaYW1iaWEFA1pNQmcQBQhaaW1iYWJ3ZQUDWldFZxYBArQBZAIJDxBkDxYJZgIBAgICAwIEAgUCBgIHAggWCRAFA0FsbAUBMGcQBQNQTVAFATFnEAUEQ0FQTQUBMmcQBQRQZ01QBQEzZxAFB1BNSS1STVAFATRnEAUGUE1JLVNQBQE1ZxAFB1BNSS1BQ1AFATZnEAUEUGZNUAUBN2cQBQdQTUktUEJBBQE4ZxYBZmQYAQUeX19Db250cm9sc1JlcXVpcmVQb3N0QmFja0tleV9fFgIFHEhlYWRlcjEkUE1JTG9naW5TdGF0dXMkY3RsMDEFHEhlYWRlcjEkUE1JTG9naW5TdGF0dXMkY3RsMDM7JHEWLRQyyqpUScR+PNM4pmOrzw=='.freeze

  queue_as :pmi_parser

  def perform(letter='A')
    if page = RestClient.post( PMI_URL, { '__VIEWSTATE' => VIEWSATE,
                                          'dph_RegistryContent$tbSearch' => letter,
                                          'dph_RegistryContent$wcountry' => 'RUS'})
      puts "Success get page for letter: #{letter}"
      filename = "parsed_pages/pmi-#{letter}.html"
      File.open(filename, 'w') do |f|
        f.write page.body
      end
      PmiParserJob.perform_now(filename)
    end
  end
end
